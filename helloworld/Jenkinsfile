pipeline {
    agent any

		triggers {
			githubPullRequests events: [Open(), commitChanged()], spec: '', triggerMode: 'HEAVY_HOOKS'
		}


		parameters {
			string(name: 'GIT_REPO', description: 'Git repository', trim: true, defaultValue: 'https://github.com/jackproudfoot-end/terraform-hello-world.git')
			string(name: 'GIT_BRANCH', description: 'Git branch', trim: true, defaultValue: 'main')
			string(name: 'INFRA_PATH', description: 'Path to infrastructure', trim: true, defaultValue: '')
		}

    stages {
        stage('Init') {
            steps {
								sh 'ls'
								git branch: "${params.GIT_BRANCH}", url: "${params.GIT_REPO}"
								sh 'ls'
            }
        }
				stage('Plan') {
					steps {
						dir("${params.INFRA_PATH}") {
							sh 'terraform init -input=false'
							sh 'terraform plan -input=false -out tfplan'
							sh 'terraform show -no-color tfplan'
						}
					}
				}
    }

		post {
			cleanup {
				cleanWs()
			}
		}
}
